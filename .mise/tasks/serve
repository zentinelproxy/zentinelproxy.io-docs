#!/usr/bin/env bash
#MISE description="Serve documentation with live reload"
#MISE env={PORT="3000", VERSION="25.12", OPEN_BROWSER="true"}

set -e

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

cd "$(dirname "$0")/../.." # Navigate to project root

echo -e "${BLUE}Starting Sentinel documentation server...${NC}"

# Check if mdbook exists
if ! command -v mdbook &> /dev/null; then
    echo -e "${RED}Error: mdBook is not installed${NC}"
    echo -e "${YELLOW}Run 'mise install' to install dependencies${NC}"
    exit 1
fi

# Check version directory
VERSION_DIR="versions/${VERSION}"
if [ ! -d "${VERSION_DIR}" ]; then
    echo -e "${RED}Error: Version directory not found: ${VERSION_DIR}${NC}"
    echo -e "${YELLOW}Available versions:${NC}"
    ls -1 versions/
    exit 1
fi

# Build open browser flag
OPEN_FLAG=""
if [[ "$OPEN_BROWSER" == "true" ]]; then
    OPEN_FLAG="--open"
fi

echo -e "${GREEN}âœ“ Starting documentation server${NC}"
echo -e "${YELLOW}  Version: ${VERSION}${NC}"
echo -e "${YELLOW}  URL: http://localhost:${PORT}${NC}"
echo -e "${YELLOW}  Live reload: Enabled${NC}"
echo -e "${BLUE}  Press Ctrl+C to stop${NC}"
echo

# Navigate to version directory and serve
cd "${VERSION_DIR}"
exec mdbook serve --port "${PORT}" ${OPEN_FLAG}
