#!/usr/bin/env bash
#MISE description="Deploy documentation to GitHub Pages"
#MISE depends=["build"]
#MISE env={CNAME="sentinel.raskell.io"}

set -e

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

cd "$(dirname "$0")/../.." # Navigate to project root

echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║   Deploying Documentation to GitHub    ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
echo

# Check if git is available
if ! command -v git &> /dev/null; then
    echo -e "${RED}Error: git is not installed${NC}"
    exit 1
fi

# Check if we're in a git repository
if [ ! -d .git ]; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

# Get repository information
REPO_URL=$(git config --get remote.origin.url)
if [ -z "$REPO_URL" ]; then
    echo -e "${RED}Error: No remote origin configured${NC}"
    exit 1
fi

echo -e "${CYAN}Repository:${NC} ${REPO_URL}"
echo

# Check if build directory exists
if [ ! -d "build" ]; then
    echo -e "${RED}Error: Build directory not found. Run 'mise run build' first.${NC}"
    exit 1
fi

# Add CNAME file
if [ -n "$CNAME" ]; then
    echo "$CNAME" > "build/CNAME"
    echo -e "${GREEN}✓ Added CNAME: ${CNAME}${NC}"
fi

# Prepare deployment
DEPLOY_DIR=$(mktemp -d)
trap "rm -rf $DEPLOY_DIR" EXIT

echo -e "${YELLOW}→ Preparing deployment...${NC}"
cp -r build/* "$DEPLOY_DIR/"

# Initialize git in deployment directory
cd "$DEPLOY_DIR"
git init
git add .

# Configure git for CI environments
if [ -n "$CI" ]; then
    git config user.name "GitHub Actions"
    git config user.email "actions@github.com"
elif [ -z "$(git config --get user.name)" ]; then
    git config user.name "Documentation Deploy"
    git config user.email "docs@sentinel.raskell.io"
fi

git commit -m "Deploy documentation - $(date '+%Y-%m-%d %H:%M:%S')"

echo -e "${YELLOW}→ Deploying to GitHub Pages...${NC}"

git remote add origin "$REPO_URL"
git push -f origin HEAD:gh-pages

echo
echo -e "${GREEN}╔════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║   Deployment Complete!                 ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════╝${NC}"
echo
echo -e "${CYAN}Documentation URL:${NC} https://${CNAME}/"
echo
echo -e "${YELLOW}Note: It may take a few minutes for changes to appear${NC}"
echo
