#!/usr/bin/env bash
#MISE description="Build all documentation versions"
#MISE env={BUILD_DIR="build", VERSIONS_DIR="versions"}

set -e

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

cd "$(dirname "$0")/../.." # Navigate to project root

echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║   Building Sentinel Documentation      ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
echo

# Check if mdbook exists
if ! command -v mdbook &> /dev/null; then
    echo -e "${RED}Error: mdBook is not installed${NC}"
    echo -e "${YELLOW}Run 'mise install' to install dependencies${NC}"
    exit 1
fi

# Check if jq exists
if ! command -v jq &> /dev/null; then
    echo -e "${RED}Error: jq is not installed${NC}"
    echo -e "${YELLOW}Run 'mise install' to install dependencies${NC}"
    exit 1
fi

# Clean previous build
echo -e "${YELLOW}→ Cleaning previous build...${NC}"
rm -rf "${BUILD_DIR}"
mkdir -p "${BUILD_DIR}"

# Read versions from versions.json
if [ ! -f "versions.json" ]; then
    echo -e "${RED}Error: versions.json not found${NC}"
    exit 1
fi

VERSIONS=$(jq -r '.versions[].path' versions.json)
DEFAULT_VERSION=$(jq -r '.default' versions.json)

echo -e "${GREEN}✓ Found versions: ${VERSIONS}${NC}"
echo -e "${GREEN}✓ Default version: ${DEFAULT_VERSION}${NC}"
echo

# Build each version
for VERSION in ${VERSIONS}; do
    VERSION_DIR="${VERSIONS_DIR}/${VERSION}"

    if [ ! -d "${VERSION_DIR}" ]; then
        echo -e "${RED}✗ Version directory not found: ${VERSION_DIR}${NC}"
        continue
    fi

    echo -e "${YELLOW}→ Building version ${VERSION}...${NC}"

    cd "${VERSION_DIR}"
    mdbook build
    cd - > /dev/null

    echo -e "${GREEN}✓ Version ${VERSION} built successfully${NC}"
done

# Copy versions.json to build directory
echo -e "${YELLOW}→ Copying versions.json...${NC}"
cp versions.json "${BUILD_DIR}/versions.json"

# Create root index.html redirect
echo -e "${YELLOW}→ Creating root redirect...${NC}"
cat > "${BUILD_DIR}/index.html" << EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="0; url=/${DEFAULT_VERSION}/">
    <title>Sentinel Documentation</title>
    <link rel="canonical" href="/${DEFAULT_VERSION}/">
</head>
<body>
    <p>Redirecting to <a href="/${DEFAULT_VERSION}/">Sentinel ${DEFAULT_VERSION} Documentation</a>...</p>
</body>
</html>
EOF

# Create 404 page
echo -e "${YELLOW}→ Creating 404 page...${NC}"
cat > "${BUILD_DIR}/404.html" << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Page Not Found - Sentinel Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #1e1e2e 0%, #313244 100%);
            color: #cdd6f4;
        }
        .container { text-align: center; padding: 2rem; }
        h1 { font-size: 6rem; margin: 0; color: #f38ba8; }
        p { font-size: 1.5rem; margin: 1rem 0; }
        a { color: #89b4fa; text-decoration: underline; }
        a:hover { color: #b4befe; }
    </style>
</head>
<body>
    <div class="container">
        <h1>404</h1>
        <p>Page not found</p>
        <p><a href="/">Go to Sentinel Documentation</a></p>
    </div>
</body>
</html>
EOF

# Create .nojekyll file
touch "${BUILD_DIR}/.nojekyll"

# Show summary
echo
echo -e "${GREEN}╔════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║   Build Complete!                      ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════╝${NC}"
echo
echo -e "${BLUE}Output directory:${NC} ${BUILD_DIR}"
SIZE=$(du -sh "${BUILD_DIR}" 2>/dev/null | cut -f1)
echo -e "${BLUE}Total size:${NC} ${SIZE}"
echo
